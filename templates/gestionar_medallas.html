{% extends "base.html" %}

{% block title %}Gestionar Medallas{% endblock %}

{% block header %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/Medallas.css') }}">
{% endblock %}

{% block content %}
<div class="medals-container">
  <div class="medals-grid">
    
    <!-- Crear nueva medalla -->
    <div>
      <div class="medal-card">
        <div class="card-header">
          <h2>Crear Nueva Medalla</h2>
        </div>
        <form method="POST">
          <input type="hidden" name="accion" value="crear">

          <div class="form-group">
            <label for="nombre" class="form-label">Nombre</label>
            <input type="text" class="form-input" id="nombre" name="nombre" required>
          </div>

          <div class="form-group">
            <label for="descripcion" class="form-label">Descripción</label>
            <textarea class="form-textarea" id="descripcion" name="descripcion"></textarea>
          </div>

          <div class="form-group">
            <label for="imagen" class="form-label">Seleccionar Imagen</label>
            <select class="form-select" id="imagen" name="imagen" onchange="mostrarVistaPrevia()" required>
              <option value="">Seleccionar imagen...</option>
              {% for img in imagenes %}
                <option value="{{ img }}">{{ img }}</option>
              {% endfor %}
            </select>
            <div class="form-hint">Las imágenes se cargan automáticamente desde static/medallas/</div>
            <img id="preview" src="" alt="Vista previa" style="display:none; width:100px; margin-top:10px; border:2px solid #000;">
          </div>

          <button type="submit" class="submit-btn">Crear Medalla</button>
        </form>
      </div>

      <!-- Asignar medalla -->
      <div class="medal-card" style="margin-top: 2rem;">
        <div class="card-header">
          <h2>Asignar Medalla</h2>
        </div>
        <form method="POST">
          <input type="hidden" name="accion" value="asignar">
          <div class="form-group">
            <label for="usuario_id" class="form-label">Usuario</label>
            <select class="form-select" id="usuario_id" name="usuario_id" required>
              <option value="">Seleccionar usuario...</option>
              {% for usuario in usuarios %}
                <option value="{{ usuario.id }}">{{ usuario.nombre }}</option>
              {% endfor %}
            </select>
          </div>

          <div class="form-group">
            <label for="medalla_id" class="form-label">Medalla</label>
            <select class="form-select" id="medalla_id" name="medalla_id" required>
              <option value="">Seleccionar medalla...</option>
              {% for medalla in medallas %}
                <option value="{{ medalla.id }}">{{ medalla.nombre }}</option>
              {% endfor %}
            </select>
          </div>

          <button type="submit" class="submit-btn btn-success">Asignar Medalla</button>
        </form>
      </div>
    </div>

    <!-- Medallas existentes -->
    <div class="medal-card">
      <div class="card-header">
        <h2>Medallas Existentes</h2>
      </div>
      {% if medallas %}
      <div class="medals-display">
        {% for medalla in medallas %}
        <div class="medal-item">
          <img src="{{ url_for('static', filename='medallas/' + medalla.imagen) }}"
               alt="{{ medalla.nombre }}"
               class="medal-img"
               onerror="this.src='https://via.placeholder.com/80?text=No+Image'">

          <form method="POST">
            <input type="hidden" name="accion" value="editar">
            <input type="hidden" name="medalla_id" value="{{ medalla.id }}">

            <input type="text" name="nombre" value="{{ medalla.nombre }}" class="form-input" style="margin-bottom:10px;">
            <textarea name="descripcion" class="form-textarea">{{ medalla.descripcion }}</textarea>

            <button type="submit" class="submit-btn" style="margin-top:10px;">Guardar</button>
          </form>

          <form method="POST" style="margin-top:10px;" onsubmit="return confirm('¿Eliminar esta medalla?')">
            <input type="hidden" name="accion" value="eliminar">
            <input type="hidden" name="medalla_id" value="{{ medalla.id }}">
            <button type="submit" class="delete-btn">Eliminar</button>
          </form>
        </div>
        {% endfor %}
      </div>
      {% else %}
      <div class="empty-state">
        <p>No hay medallas creadas</p>
      </div>
      {% endif %}
    </div>
  </div>
</div>

<!-- Subir imagen -->
<div class="medal-card" style="margin-top: 2rem; width: 90%; margin: 0 auto;">
  <div class="card-header">
    <h2>Subir Imagen de Medalla</h2>
  </div>
  <form method="POST" enctype="multipart/form-data" action="{{ url_for('subir_imagen_medalla') }}">
    <div class="form-group">
      <label for="nombre_imagen" class="form-label">Nombre de la imagen</label>
      <input type="text" class="form-input" id="nombre_imagen" name="nombre_imagen" placeholder="Ej: oro, plata, bronce" required>
    </div>
    <div class="form-group">
      <label for="imagen" class="form-label">Seleccionar imagen</label>
      <input type="file" class="form-input" id="imagen" name="imagen" accept="image/*" required>
    </div>
    <button type="submit" class="submit-btn">Subir Imagen</button>
  </form>
</div>

<script>
function mostrarVistaPrevia() {
  const select = document.getElementById('imagen');
  const img = document.getElementById('preview');
  const valor = select.value;
  if (valor) {
    img.src = "{{ url_for('static', filename='medallas/') }}" + valor;
    img.style.display = 'block';
  } else {
    img.style.display = 'none';
  }
}
</script>
{% endblock %}
