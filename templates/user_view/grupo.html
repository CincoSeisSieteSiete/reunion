{% extends "base.html" %}

{% block title %}{{ grupo.nombre }}{% endblock %}

{% block header %}
    <link rel="stylesheet" href="{{ url_for('static', filename='css/grupo/base.css') }}">
    {% if session.get('tema', 0) == 0 %}
        <link rel="stylesheet" href="{{ url_for('static', filename='css/light/light.css') }}">
    {% else %}
        <link rel="stylesheet" href="{{ url_for('static', filename='css/dark/dark.css') }}">
    {% endif %}
{% endblock %}


{% block content %}

<section class="regreso">
    <a href="/dashboard" class="back-link">
        <img class="imgs_dark" src="{{ url_for('static', filename='iconos/arrow-left.svg') }}" alt="Regresar">
    </a>
</section>

<main class="ui-container">

    <header class="ui-header">

        <h1 class="ui-title">{{ grupo.nombre }}</h1>
        <p class="ui-desc">{{ grupo.descripcion or 'Sin descripci√≥n disponible.' }}</p>
        
        <div class="header-meta">
            <span class="admin-badge">Admin: {{ grupo.admin_nombre }}</span>
        </div>


        <div class="code-component" onclick="copiarCodigo(this, '{{ grupo.codigo_invitacion }}')">
            <div class="code-label">C√≥digo de invitaci√≥n</div>
            <div class="code-value">
                {{ grupo.codigo_invitacion }}
                <div style="display: flex; gap: 10px; align-items: center;">
                    <a href="https://api.whatsapp.com/send?text={{ url_for('unirse_grupo', codigo=grupo.codigo_invitacion, _external=True) }}" 
                       target="_blank" 
                       onclick="event.stopPropagation()" 
                       title="Compartir por WhatsApp"
                       style="color: #25D366; display: flex; align-items: center;">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.304-5.291c0-5.449 4.432-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.888 9.884m0-19.857C3.875 1.928.001 5.801.001 10.557c0 1.675.437 3.278 1.268 4.69L.003 24l8.915-2.336c1.37.747 2.922 1.141 4.518 1.141h.003c5.514 0 9.994-4.481 9.994-9.994 0-2.67-1.039-5.18-2.905-7.046A9.922 9.922 0 0112.051 1.928z"/></svg>
                    </a>
                    <span class="copy-icon">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2-2v1"></path></svg>
                    </span>
                </div>
            </div>
            <div class="toast">¬°Copiado!</div>
        </div>
    </header>

    <div class="ui-actions">
        {% if es_admin %}
        <a href="{{ url_for('tomar_asistencia', grupo_id=grupo.id) }}" class="action-btn primary">
            <span>üìù</span> Tomar Asistencia
        </a>
        <a href="{{ url_for('gestionar_puntos', grupo_id=grupo.id) }}" class="action-btn secondary">
            <span>‚ö°</span> Gestionar Puntos
        </a>
        {% endif %}
        <a href="{{ url_for('cumpleanos', id_grupo=grupo.id) }}" class="action-btn ghost">
            <span>üéÇ</span> Cumplea√±os
        </a>
    </div>

    <hr class="ui-divider">

    <section class="ranking-section">
        <div class="section-header">
            <h2>Tabla de Clasificaci√≥n</h2>
        </div>

        {% if ranking|length > 0 %}
        <div class="podium-layout">
            
            {% if ranking[0] %}
            <div class="rank-card gold">
                <div class="rank-medal">ü•á</div>
                <div class="rank-avatar-lg">{{ ranking[0].nombre[0] | upper }}</div>
                <div class="rank-info">
                    <h3>{{ ranking[0].nombre }}</h3>
                    <div class="rank-score">{{ ranking[0].puntos }} pts</div>
                </div>
                <div class="rank-badge">L√≠der</div>
            </div>
            {% endif %}

            <div class="runners-up-list">
                {% if ranking[1] %}
                <div class="rank-row-item silver">
                    <div class="pos-circle">2</div>
                    <div class="row-avatar">{{ ranking[1].nombre[0] | upper }}</div>
                    <div class="row-name">{{ ranking[1].nombre }}</div>
                    <div class="row-points">{{ ranking[1].puntos }} pts</div>
                </div>
                {% endif %}

                {% if ranking[2] %}
                <div class="rank-row-item bronze">
                    <div class="pos-circle">3</div>
                    <div class="row-avatar">{{ ranking[2].nombre[0] | upper }}</div>
                    <div class="row-name">{{ ranking[2].nombre }}</div>
                    <div class="row-points">{{ ranking[2].puntos }} pts</div>
                </div>
                {% endif %}
            </div>
        </div>
        {% endif %}

        {% if ranking|length > 3 %}
        <div class="table-container">
            <table class="ui-table">
                <thead>
                    <tr>
                        <th width="50">Pos</th>
                        <th>Integrantes</th>
                        <th class="text-right">Puntos</th>
                    </tr>
                </thead>
                <tbody>
                    {% for usuario in ranking[3:] %}
                    <tr>
                        <td><span class="pos-number">{{ loop.index + 3 }}</span></td>
                        <td>
                            <div class="user-flex">
                                <div class="avatar-xs">{{ usuario.nombre[0] | upper }}</div>
                                <span style="text-overflow: ellipsis; white-space: nowrap; overflow: hidden;" >{{ usuario.nombre }}</span>
                            </div>
                        </td>
                        <td class="text-right"><strong>{{ usuario.puntos }}</strong></td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% endif %}

    </section>

</main>

<script>
function copiarCodigo(element, codigo) {
    navigator.clipboard.writeText(codigo).then(() => {
        element.classList.add('copied');
        setTimeout(() => element.classList.remove('copied'), 2000);
    });
}
</script>
{% endblock %}